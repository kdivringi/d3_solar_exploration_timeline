<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <style>
    .d3-tip {
      line-height: 1;
      font-weight: bold;
      padding: 12px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 2px;
    }

    .axis path,
    .axis line, 
    .locs path,
    .locs line {
      fill: none;
      stroke: black;
    }
  </style>
  <script type="text/javascript">
    function draw(locs) {
        	
      // Set scale & axis regions
      var margin = 75,
          width = 940 - margin,
          height = 700 - margin;

      // d3.select("body")
      //   .append("h2")
      //   .text("Timeline of Solar System Exploration");

      var svg = d3.select("#vis")
        .attr("width", width + margin)
        .attr("height", height + margin);

      // Draw Places / Year Scales

      var g = d3.select("svg")
        .append('g')
        .attr("class", "locs");


      var loc_scale = d3.scale.ordinal()
        .domain(locs.map(function (d) {return d['name'];}))
        .rangeBands([0,height],0,0.05);
        // .range(locs.map(function (d) {return +d['position']*height;}));
        // debugger;
      var loc_axis = d3.svg.axis()
        .scale(loc_scale)
        .orient("left");
      
      // g.selectAll("text")
      //   .data(locs)
      //   .enter()
      //   .append("text")
      //   .attr("y", function (d) {return +d['position']*height;})
      //   .text(function (d) {return d['name'];});


      var p_delta = loc_scale.rangeBand()//0.091;

      g.selectAll("rect.back")
        .data(locs)
        .enter()
        .append("rect")
        .attr("class", "back")
        .attr("x", 0)
        .attr("y", function (d) { 
          return loc_scale(d['name']);
        })
        .attr("width", width - margin)
        .attr("height",p_delta)
        .style("fill", function (d) {return d['color'];})
        .style("opacity", 0.35);



      var time_scale = d3.scale.linear()
        .range([margin, width])
        .domain([1958, 2015]);

      // var loc_axis = d3.svg.axis()
      //   .scale(loc_scale)
      //   .orient("left");

      var time_axis = d3.svg.axis()
        .scale(time_scale)
        .orient("bottom")
        .tickFormat(d3.format("04d"));

      var tip = d3.tip()
        .attr("class", "d3-tip")
        .direction('s')
        .html(function (d) {
          clearTimeout();
          var text = '<a href="' + d['link'] + '" target="_blank" >' +d['name']+"</a>";
          text += "<br><strong>Launch:</strong> " + d['launch'];
          text += "<br><strong>Arrival:</strong> " + d['arrival'];
          text += "<br><strong>End:</strong> " + d['end'];
          text += "<br><strong>Type:</strong> " + d['type'];
          if (d['success']==="True") {
            text +="<br><strong>Mission:</strong> SUCCESS";
          } else{
            text +="<br><strong>Mission:</strong> FAILURE";
          }
          return text;
        });

      svg.call(tip)

      svg.on("click", tip.hide);

      // Function to draw mission path
      function draw_missions(data) {
        // debugger;

        // Draw trip section of path
          // Not if launch=arrival
          // Appropriate marker type
          // Stagger y for each mission on track

        var loop_limit = 12;
        var time_delta = time_scale(2001) - time_scale(2000);

        function calc_x_factor(i) {
          var mod = i % loop_limit;
          var x_factor = time_delta * mod/loop_limit - 0.5*time_delta;
          return x_factor;
        }

        function calc_y_factor(i) {
          var mod = i % loop_limit;
          var band = loc_scale.rangeBand();
          var y_factor = 0.05 * band + 0.9*(band * mod/loop_limit);
          return y_factor;
        }

        function select_marker(d) {
          if (d['success']==="True") {
            return "url(#Triangle)";
          } else {
            return "url(#Cross)";
          }
        }

        svg.append('g')
          .attr("class","mission")
          .selectAll("path.trip")
          .data(data)
          .enter()
          .append("path")
          .attr("class", "trip")
          .attr("stroke", "black")
          .attr("stroke-width", 1)
          .attr("stroke-dasharray", "5,5")
          .attr('d', function (d, i) {
            var x_factor = calc_x_factor(i)*0.9;
            var y_factor = calc_y_factor(i)*0.9;
            var x0 = time_scale(d['launch']); 
            var x1 = time_scale(d['arrival']);
            if (x0===x1) {
              return "";
            }

            var y0 = loc_scale("Earth") + y_factor;
            var y1 = loc_scale(d['destination']) + y_factor; 
            return "M" + x0 + " " + y0 + " L" + x1 + " " + y1;
          });

        d3.select("g.mission")
          .selectAll("path.activity")
          .data(data)
          .enter()
          .append("path")
          .attr("class", "activity")
          .attr("stroke", "black")
          .attr("stroke-width", 1.5)
          .attr("marker-end", select_marker)
          .attr("d", function (d, i) {
            var x_factor = calc_x_factor(i)*0.9;
            var y_factor = calc_y_factor(i)*0.9;
            var x0 = time_scale(d['arrival']); 
            var x1 = time_scale(d['end']);
            if (x0===x1) {
              x0 = x0 - 0.25*time_delta;
              x1 = x1 + 0.25*time_delta;
            }
            var y0 = loc_scale(d['destination']) + y_factor;
            var y1 = loc_scale(d['destination']) + y_factor;
            return "M" + x0 + " " + y0 + " L" + x1 + " " + y1;
          })
          .on("mouseover", tip.show);

        g.selectAll("text")
          .on("click", zoom_loc)

        function update_missions(t_time) {

          debugger;
          var m_filtered;
          var loc_filtered;
          if (loc_scale.domain().length === 1) {
            m_filtered = data.filter(function (d) {
              return d['destination'] === loc_scale.domain()[0];
            });
            loc_filtered = locs.filter(function (d) {
              return d['name'] === loc_scale.domain()[0];
            });
          } else {
            m_filtered = data;
            loc_filtered = locs;
          };

          function keyfunc (d) {return d['name'];}

          var trips = d3.select("g.mission")
            .selectAll('path.trip')
            .data(m_filtered, keyfunc);

          trips.exit().remove()

          trips.enter()
            .append("path")
            .attr("class", "trip")
            .attr("stroke", "black")
            .attr("stroke-width", 1)
            .attr("stroke-dasharray", "5,5")
            .attr('d' , function (d) {
              var x0 = time_scale(d['launch']);
              var x1 = time_scale(d['arrival']);
              var y = 0;
              if (x0===x1) {
                return "";
              } else {
                return "M" + x0 + " " + y + " L" + x1 + " " + y
              }
            });

          trips.transition()
            .duration(t_time)
            .attr("d", function (d, i) {
              var x_factor = calc_x_factor(i)*0.9;
              var y_factor = calc_y_factor(i)*0.9;
              var x0 = time_scale(d['launch']); 
              var x1 = time_scale(d['arrival']);
              if (x0===x1) {
                return "";
              }
              if (loc_scale.domain().length===1) {
                var y0 = loc_scale(d['destination']) + y_factor;
              } else {
                var y0 = loc_scale("Earth") + loc_scale.rangeBand()*0.5;
              }

              var y1 = loc_scale(d['destination']) + y_factor; 
              return "M" + x0 + " " + y0 + " L" + x1 + " " + y1;
            });

          activities = d3.select("g.mission")
            .selectAll('path.activity')
            .data(m_filtered, keyfunc);

          activities.exit().remove();

          activities.enter()
            .append("path")
            .attr("class", "activity")
            .attr("stroke", "black")
            .attr("stroke-width", 1.5)
            .attr("marker-end", select_marker)
            .attr("d", function (d) {
              var x0 = time_scale(d['arrival']); 
              var x1 = time_scale(d['end']);
              var y = 0;
              return "M" + x0 + " " + y + " L" + x1 + " " + y;
            })
            .on("mouseover", tip.show);

          if (loc_scale.domain().length===1) {
            m_names = d3.select("g.mission")
              .selectAll("text.name")
              .data(m_filtered, keyfunc);


            m_names.enter()
              .append("text")
              .attr("class", "name")
              .attr("x", function (d) {return time_scale(d['launch']);})
              .attr("y", 0)
              .attr("y", function (d, i) {
                var y_factor = calc_y_factor(i)*0.9;
                return loc_scale(d['destination']) + y_factor;
              })
              .attr("opacity", 0)
              .text(function (d) {return d['name']});

            m_names.transition()
              .duration(t_time)
              .attr("opacity", 1);            
          } else {
            m_names.transition()
              .duration(t_time)
              .attr("opacity", 0)
              .remove()
          }



          activities.transition()
            .duration(t_time)
            .attr()
            .attr("d", function (d, i) {
              var x_factor = calc_x_factor(i)*0.9;
              var y_factor = calc_y_factor(i)*0.9;
              var x0 = time_scale(d['arrival']); 
              var x1 = time_scale(d['end']);
              if (x0===x1) {
                x0 = x0 - 0.25*time_delta;
                x1 = x1 + 0.25*time_delta;
              }
              var y0 = loc_scale(d['destination']) + y_factor;
              var y1 = loc_scale(d['destination']) + y_factor;
              return "M" + x0 + " " + y0 + " L" + x1 + " " + y1;
            });


          rects = g.selectAll("rect.back")
            .data(loc_filtered, keyfunc);

          rects.exit()
            .transition()
            .duration(t_time*0.75)
            .style("opacity", 0)
            .remove();

          rects.enter()
            .append("rect")
            .attr("class", "back")
            .attr("x", 0)
            .attr("width", width - margin)
            .style("fill", function (d) {return d['color'];})
            .style("opacity", 0);

          rects.transition()
            .duration(t_time)
            .attr("y", function (d) {
              return loc_scale(d['name']);
            })
            .attr("height", loc_scale.rangeBand())
            .style("opacity", 0.35);

          g.selectAll("text")
          .on("click", zoom_loc)

        }

        function zoom_loc(d, i) {
          to_loc = d3.select(this).text();
          if (to_loc==="Earth") {
            return;
          } else if (loc_scale.domain().length === 1) {
            loc_scale.domain(locs.map(function (d) {return d['name'];}))
              .rangeBands([0,height],0,0.05);
          } else {
            loc_scale.domain([to_loc]);
            loc_scale.rangeBands([0, height]);
          }
          var t_time = 1000;
          d3.select("g.locs").transition().duration(t_time)
            .call(loc_axis);
          update_missions(t_time);
        }

      }

      d3.tsv("solar_exploration.tsv", draw_missions);

      svg.append('g')
        .attr('class', 'x axis')
        .attr('transform', "translate(0," + height + ")")
        .call(time_axis);

      svg.select("g.locs")
        .attr("transform", "translate(" + margin + ",0)")
        .call(loc_axis);
      debugger;

      // Bind and draw everything

    	// Set Mouseover events

    	// Set button actions/transitions
    	
    }
      </script>
  </head>
<body>
  <div class="container">
  <div class="row">
    <h1>Timeline of Solar System Exploration</h1>
    <div class="span12">
      <svg id="vis">
            <defs>
              <marker id="Triangle"
                      viewBox="0 0 10 10" 
                      refX="1" refY="5"
                      markerWidth="6" 
                      markerHeight="6"
                      orient="auto">
                  <path d="M 0 0 L 10 5 L 0 10 z" />
              </marker>
              <marker id ="Cross" 
                      viewBox="0 0 10 10" 
                      refX="3" refY="5" 
                      markerWidth="5" 
                      markerHeight="5" 
                      orient="auto"
                      stroke="black"
                      stroke-width = "1.5">
                <path d="M 0 0 L 10 10 M 0 10 L 10 0"/>
            </marker>
            </defs>

      </svg>
    </div>
  </div>
  <div class="row">
    <div class="span4" id="planets">
      <h4>Legend</h4>
      <p>Here are what some of the symbols mean</p>
      <p>Mouse-over missions for more information</p>
      <p>Click locations on the right to zoom in</p>
    </div>
    <div class="span8" id="years">
      <p>This visualization is based off of this link.</p>
      <p>My name is Kaan Divringi and this is a final project for the Udacity nanodegree class on D3.</p>
    </div>
    
  </div>
  </div>

  <script type="text/javascript">
  /*
    */
  d3.tsv("locations.tsv", draw);
  </script>
</body>
</html>
